#before vagant up, write the code for:
#   galaxy requirements intalation 
#   galaxy instalation
#   galaxy configurations
#   tools instalation
#   tools test
#Docker?

- hosts: all
  remote_user: vagrant
  sudo: yes

  vars:
    local_home: "{{ lookup('env','HOME') }}"
    galaxy_relative_dir: galaxy_dist
    galaxy_ip: 0.0.0.0
    galaxy_port: 8080
    postgresql_package: postgresql-9.3
    git_package: git 
    build_package: build-essential
    
  tasks:
  - name: install build essentials on Debian VM
    apt: pkg={{ build_package }} state=latest update_cache=no
    become_user: root
    become_method: sudo    

  - name: install git on Debian VM
    apt: pkg={{ git_package }} state=latest update_cache=yes
    become_user: root
    become_method: sudo    

  - name: install postgresql on Debian VM
    apt: pkg={{ postgresql_package }} state=latest update_cache=no
    become_user: root
    become_method: sudo    

#      - libpq-dev
  - name: install postgresql ansible on Debian VM
    apt: pkg=python-psycopg2 state=latest update_cache=no
    become_user: root
    become_method: sudo    

  - shell: pg_createcluster 9.3 main --start
    become_user: root
    become_method: sudo    
    ignore_errors: yes
    
#useradd galaxy; mkdir /home/galaxy; chown -R galaxy:galaxy /home/galaxy
  - user: name=galaxy shell=/bin/bash groups=admin password=galaxy home=/home/galaxy/ createhome=yes append=yes
    become_user: root
    become_method: sudo    

  - postgresql_user: name=galaxy
    become_user: postgres
    become_method: sudo    

  - postgresql_db: name=galaxy owner=galaxy
    become_user: postgres
    become_method: sudo    

  - git: repo=https://github.com/galaxyproject/galaxy/ dest=/home/galaxy/{{ galaxy_relative_dir }}/ clone=yes update=yes
    become_user: galaxy
    become_method: sudo    
  
  - copy: src=/home/galaxy/{{ galaxy_relative_dir }}/config/galaxy.ini.sample dest=/home/galaxy/{{ galaxy_relative_dir }}/config/galaxy.ini
    become_user: galaxy
    become_method: sudo    

  - copy: src=/home/galaxy/{{ galaxy_relative_dir }}/config/tool_sheds_conf.xml.sample dest=/home/galaxy/{{ galaxy_relative_dir }}/config/tool_sheds_conf.xml
    become_user: galaxy
    become_method: sudo    

  - replace: dest=/home/galaxy/{{ galaxy_relative_dir }}/config/galaxy.ini regexp='#host = 127.0.0.1' replace='host = {{ galaxy_ip }}' backup=no
    become_user: galaxy
    become_method: sudo    

  - replace: dest=/home/galaxy/{{ galaxy_relative_dir }}/config/galaxy.ini regexp='#port = 8080' replace='port = {{ galaxy_port }}' backup=no
    become_user: galaxy
    become_method: sudo    

  - replace: dest=/home/galaxy/{{ galaxy_relative_dir }}/config/galaxy.ini regexp='#tool_dependency_dir = None' replace='tool_dependency_dir = ../dependencies/' backup=no
    become_user: galaxy
    become_method: sudo    
   
  - replace: dest=/home/galaxy/{{ galaxy_relative_dir }}/config/galaxy.ini regexp='#admin_users = None' replace='admin_users = fabiorjvieira@gmail.com' backup=no
    become_user: galaxy
    become_method: sudo    

  - replace: dest=/home/galaxy/{{ galaxy_relative_dir }}/config/galaxy.ini regexp='#database_connection = sqlite:///./database/universe.sqlite?isolation_level=IMMEDIATE' replace='database_connection = postgresql:///galaxy?host=/var/run/postgresql' backup=no
    become_user: galaxy
    become_method: sudo    

  - lineinfile: dest=/home/galaxy/{{ galaxy_relative_dir }}/config/tool_sheds_conf.xml line='   <tool_shed name="ARTbio Tool Shed" url="https://lbcd41.snv.jussieu.fr/toolshed/"/>' regexp='<tool_sheds>' state=present insertafter=yes
    become_user: galaxy
    become_method: sudo    
  
  - copy: src=/home/galaxy/{{ galaxy_relative_dir }}/contrib/contrib/galaxy.debian-init dest=/etc/init.d/contrib/galaxy mode="+r" 
    become_user: root
    become_method: sudo    
 
#  - service: name=galaxy state=started
#    become_user: root
#    become_method: sudo    
    
#No handlers could be found for logger "galaxy.config"
#galaxy.eggs WARNING 2015-10-07 12:35:38,509 Warning: pbr (a dependent egg of sqlalchemy-migrate) cannot be fetched
