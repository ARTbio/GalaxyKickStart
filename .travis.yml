---
python: "2.7"
sudo: required
dist: trusty

env:
  - TOXENV=py27

before_install:
  - export GALAXY_TRAVIS_USER=galaxy
  - export GALAXY_HOME=/home/galaxy
  - export GALAXY_USER=artimed@gmail.com
  - export GALAXY_USER_EMAIL=$GALAXY_USER
  - export GALAXY_USER_PASSWD=artimed
  - export BIOBLEND_GALAXY_API_KEY=f137d9af2f2065bd8c5fbadf7111494b
  - export BIOBLEND_GALAXY_URL=http://localhost:8080
  - sudo docker build -t galaxy_kickstart .

script:
  # Check the role/playbook's syntax.
  ## - sudo ansible-playbook -i "localhost," galaxy.yml --syntax-check
  # run the full playbook
  # - sudo ansible-playbook -i "localhost," -c local -vvvv galaxy.yml
  # run playbook with settings required for bioblend
  ##- sudo ansible-playbook -i hosts -l travis_bioblend -vvvv galaxy.yml
  ##- sudo mkdir /export && sudo chown galaxy:galaxy /export
  # Run again, but with export
  ## - sudo ansible-playbook -i hosts -l travis_bioblend -vvvv galaxy.yml
  # Run again
  ## - sudo ansible-playbook -i hosts -l travis_bioblend -vvvv galaxy.yml
  - sudo docker run --privileged -d -p 8021:21 -p 8080:80 -v /export:/export -v /tmp:/tmp galaxy_kickstart
  - sudo pip install https://github.com/mvdbeek/bioblend/archive/master.tar.gz
  - sudo pip install --upgrade "tox>=1.8.0"
  - wget https://github.com/mvdbeek/bioblend/archive/master.tar.gz
  - tar xfz master.tar.gz
  - cd bioblend-master 
  - sudo mkdir /export && sudo chown 1111:1111 /export
  - curl --fail $BIOBLEND_GALAXY_URL/api/version
  - time > /tmp/time.txt && curl --fail -T /tmp/time.txt ftp://localhost:8021 --user $GALAXY_USER:$GALAXY_USER_PASSWD
  - curl --fail ftp://localhost:8021 --user $GALAXY_USER:$GALAXY_USER_PASSWD
  # bioblend nose-tests
  - tox -e $TOXENV -- -e 'test_download_dataset'
