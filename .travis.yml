---
language: python
python: "2.7"
sudo: required
dist: trusty

env:
  global:
    - TOX_ENV=py27
    - SITE_URL="https://artbio.github.io/ansible-artimed/"
    - GH_USER_NAME="Marius van den Beek"
    - GH_USER_EMAIL="m.vandenbeek@gmail.com"
    - GH_REF="github.com/ARTbio/ansible-artimed.git"
    - secure="pseB6yOf48IPBRjuqXz+huJORBEtbaiyGnqE4NQVX0LXzNPpwaVBNURIMfvbPhZ5OhoEhnt8a0dZT95fQie0H82oQU9vJ73tBb/rNlytbtJQ4cXYOqn4HRzQsrHY1Tns5++LZmTrLWGKTGvO3bCg6nBTXSmda4kr46tEUJCI9IZRWPHIZu2MjfSMe5qxu4cT11hzQw6NuoTJs+B49uvz+0MCSP+Q3bDGHauVP6n/NjEItka1Rw75GIb+BqqKN4TQ+Wpv9+bM+WuUGdUNGDaFyR9y/M1Br6z+YfySu0OBjZuEf4bF3ZSh70W8VBm3fQW+aOZw3U9GA2FOcVERSGdMDq8UYj52T0c0d38pXCsxj51MFQ5eIlXp2tUSW/S8nttynGYWTqmUngin/qm6w6JnC+g6RLWlRhPYZfgZ/UggBu883N49OYj33hSwVlSmIspmK5KjD8t9X3LuRwbRPeNXTsHZppAEbFu/HezxxY1lK/pQepQIs5SHy1bXCMnLhQajfzrH82EiY7U/DEyYkrUPaHVBU27CmaNFA9g/l/SZaWnUq/ZQaKloQCBXoVGudrX4MWcIf4Do95WUTzZl4qc+2GhzIy9HZA9IA27zHW5FD5NhFf58ICmIkyhMlndIG3K8neRDRVn3keoh79feqOibyevSuQ8w3xaNBi4zr5eTqus="

before_install:
  - export GALAXY_TRAVIS_USER=galaxy
  - export GALAXY_UID=1450
  - export GALAXY_GID=1450
  - export GALAXY_HOME=/home/galaxy
  - export GALAXY_USER=admin@galaxy.org
  - export GALAXY_USER_EMAIL=admin@galaxy.org
  - export GALAXY_USER_PASSWD=admin
  - export BIOBLEND_GALAXY_API_KEY=admin
  - export BIOBLEND_GALAXY_URL=http://localhost:8080

  - docker --version
  - docker info

  - sudo groupadd -r $GALAXY_TRAVIS_USER -g $GALAXY_GID
  - sudo useradd -u $GALAXY_UID -r -g $GALAXY_TRAVIS_USER -d $GALAXY_HOME -p travis_testing -c "Galaxy user" $GALAXY_TRAVIS_USER
  - sudo mkdir $GALAXY_HOME
  - sudo chown -R $GALAXY_TRAVIS_USER:$GALAXY_TRAVIS_USER $GALAXY_HOME
  - docker build -t galaxy_kickstart .
  - sudo mkdir /export && sudo chown $GALAXY_UID:$GALAXY_GID /export
  - |
    docker run -d -p 8080:80 -p 8021:21 -p 8800:8800 \
    --privileged=true \
    -e GALAXY_CONFIG_ALLOW_USER_DATASET_PURGE=True \
    -e GALAXY_CONFIG_ALLOW_LIBRARY_PATH_PASTE=True \
    -e GALAXY_CONFIG_ENABLE_USER_DELETION=True \
    -e GALAXY_CONFIG_ENABLE_BETA_WORKFLOW_MODULES=True \
    -v /tmp/:/tmp/ \
    -v /export/:/export \
    galaxy_kickstart
  - docker ps
  - cd $GALAXY_HOME
  - sudo su $GALAXY_TRAVIS_USER -c 'wget https://github.com/bgruening/bioblend/archive/master.tar.gz'
  - sudo su $GALAXY_TRAVIS_USER -c 'tar xfz master.tar.gz'

install:
  - cd $GALAXY_HOME/bioblend-master
  - sudo su $GALAXY_TRAVIS_USER -c 'pip install --user --upgrade "tox>=1.8.0" "pep8<=1.6.2" '
  - sudo su $GALAXY_TRAVIS_USER -c 'python setup.py install --user'
  # remove flake8 testing for bioblend from tox
  - sudo su $GALAXY_TRAVIS_USER -c 'sed -i.bak "s/commands.*$/commands =/" tox.ini'

script:
  - sleep 30s
  # Run bioblend nosetests with the same UID and GID as the galaxy user inside if Docker
  # this will guarantee that exchanged files bewteen bioblend and Docker are read & writable from both sides
  - sudo -E su $GALAXY_TRAVIS_USER -c "export PATH=$GALAXY_HOME/.local/bin/:$PATH && cd $GALAXY_HOME/bioblend-master && tox -e $TOX_ENV -- -e 'test_download_dataset'"
  # Test the 'old' tool installation script
  #- docker run galaxy-docker/test bash -c 'install-repository "--url https://toolshed.g2.bx.psu.edu -o iuc --name bedtools --panel-section-name 'BEDTools'"'
  # Test the 'new' tool installation script
  #- docker run galaxy-docker/test bash -c "install-tools $GALAXY_HOME/ansible/galaxy-tools-playbook/files/tool_list.yaml"
  # Test Docker in Docker, used by Interactive Environments; This needs to be at the end as Docker takes some time to start.
  #- docker exec -i -t galaxy_test_container docker info
  - curl --fail $BIOBLEND_GALAXY_URL/api/version
  - time > $HOME/time.txt && curl --fail -T $HOME/time.txt ftp://localhost:8021 --user $GALAXY_USER:$GALAXY_USER_PASSWD
  - curl --fail ftp://localhost:8021 --user $GALAXY_USER:$GALAXY_USER_PASSWD
  # Change back to $TRAVIS_BUILD_DIR, since deployment will fail otherwise
  - cd $TRAVIS_BUILD_DIR
deploy:
  provider: script
  script: bash ./deploy.sh
  on:
    branch: master
