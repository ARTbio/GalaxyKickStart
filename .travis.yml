---
python: "2.7"
sudo: required
dist: trusty

env:
  - TOXENV=py27

before_install:
  - sudo service postgresql stop
  - sudo apt-get remove -y --purge postgresql-*
  - export GALAXY_USER=artimed@gmail.com
  - export GALAXY_USER_EMAIL=$GALAXY_USER
  - export GALAXY_USER_PASSWD=artimed
  - export BIOBLEND_GALAXY_API_KEY=f137d9af2f2065bd8c5fbadf7111494b
  - export BIOBLEND_GALAXY_URL=http://localhost:80

install:
  # Install Ansible.
  - sudo pip install ansible
  - pip install --user https://github.com/bgruening/bioblend/archive/master.tar.gz
  - pip install --user --upgrade "tox>=1.8.0" "pep8<=1.6.2"
  - wget https://github.com/bgruening/bioblend/archive/master.tar.gz
  - tar xzf master.tar.gz

script:
  # Check the role/playbook's syntax.
  - sudo ansible-playbook -i "localhost," galaxy.yml --syntax-check
  # run the full playbook
  - sudo ansible-playbook -i "localhost," -c local -vvvv galaxy.yml
  # run playbook again, but with settings required for bioblend
  - sudo ansible-playbook -i hosts -l travis_bioblend -vvvv galaxy.yml
  - curl $BIOBLEND_GALAXY_URL/api/version
  - time > $HOME/time.txt && curl --fail -T $HOME/time.txt ftp://localhost:21 --user $GALAXY_USER:$GALAXY_USER_PASSWD
  - curl --fail ftp://localhost:21 --user $GALAXY_USER:$GALAXY_USER_PASSWD
  # bioblend nose-tests
  - cd bioblend-master 
  - tox -e $TOXENV -- -e 'test_download_dataset'
