- name: Create users group
  group: name=users state=present
  when: manage_postgresql

- name: Put postgres into users group
  shell: adduser postgres users
  when: manage_postgresql
#  user: name=postgres groups="postgres,users"

- name: Check postgresql dir for galaxy
  stat: path={{ galaxy_database }}
  register: dir_sym
  when: manage_postgresql

- name: Create postgresql dir for galaxy
  file: path={{ galaxy_database }} owner=postgres group=postgres mode=0700 state=directory
  when: manage_postgresql and (dir_sym.stat.islnk is not defined)

- name: Give postgres access to galaxy_database directory chain
  file: path=/{{ galaxy_database_items[1] }} mode=0755 group=users #recurse=yes
#  with_items: "{{ galaxy_database_items }}"
  when: manage_postgresql and (galaxy_database_items[1] is defined)

- name: Postgresql version
  shell: ls -C1 /etc/postgresql/
  register: postgresql_version

- set_fact: postgresql_version="{{ postgresql_version.stdout }}"

- name: Stop supervisor postgreSQL
  supervisorctl: name="postgresql" state=stopped
  when: manage_postgresql and not service_postgresql and (dir_sym.stat.islnk is not defined)
  register: supervisor_postgresql_success
  ignore_errors: yes
  
- name: Stop postgresql
  service: name=postgresql state=stopped
  when: manage_postgresql and (service_postgresql or (supervisor_postgresql_success.failed is defined)) and (dir_sym.stat.islnk is not defined)

#upgrade: automaticlly dicovers where is the postgresql master db (pg_lsclusters)
- name: Copy postgresql db
  shell: cp -vr /var/lib/postgresql/{{ postgresql_version }}/main {{ galaxy_database }}/
  when: manage_postgresql and (dir_sym.stat.islnk is not defined)
  sudo: yes
  sudo_user: postgres

- name: Copy postgresql config files
  shell: cp -vr /etc/postgresql/{{ postgresql_version }}/main/*.conf {{ galaxy_database }}/
  when: manage_postgresql and (dir_sym.stat.islnk is not defined)
  sudo: yes
  sudo_user: postgres

- name: Fix hba and ident locations in the config file
  replace: hba_file = 
  with_items: 
    - "hba_file = "

- name: Check postgresql backup dir
  stat: path=/var/lib/postgresql/{{ postgresql_version }}/main.backup/PG_VERSION
  register: dir_sym

- name: Backup postgresql db
  shell: mv -v /var/lib/postgresql/{{ postgresql_version }}/main /var/lib/postgresql/{{ postgresql_version }}/main.backup
  when: manage_postgresql and (dir_sym.stat.islnk is not defined)
  sudo: yes
  sudo_user: postgres

- name: Check postgresql symlink for galaxy
  stat: path=/var/lib/postgresql/{{ postgresql_version }}/main
  register: dir_sym

- name: Create a symlink for postgresql
  shell: ln -s {{ galaxy_database }}/main /var/lib/postgresql/{{ postgresql_version }}/
  when: manage_postgresql and ((dir_sym.stat.islnk is not defined) or (not dir_sym.stat.islnk))
  sudo: yes
  sudo_user: postgres

- set_fact:
    supervisor_postgres_database_path: "/var/lib/postgresql/{{ postgresql_version }}/main" 
    supervisor_postgres_database_config: "/var/lib/postgresql/{{ postgresql_version }}/main/postgresql.conf"

- name: Start supervisor postgreSQL
  supervisorctl: name="postgresql" state=started
  when: manage_postgresql and not service_postgresql and (dir_sym.stat.islnk is not defined)
  register: supervisor_postgresql_success
  ignore_errors: yes

- name: Start postgresql
  service: name=postgresql state=started
  when: manage_postgresql and (service_postgresql or (supervisor_postgresql_success.failed is defined)) and (dir_sym.stat.islnk is not defined)
  