# As GalaxyKickStart did its job, we can hard link slurmd.conf and munge.key

- name: hard link slurmd.conf and munge.key
  file:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    state: hard
  with_items:
    - { src: '/etc/slurm-llnl/slurm.conf', dest: '/home/galaxy/slurm.conf' }
    - { src: '/etc/munge/munge.key', dest: '/home/galaxy/munge.key' } 

- name: set permissions for munge.key
  file:
    path: /etc/munge/munge.key
    state: file
    follow: yes
    owner: 1450
    group: 100
    mode: 0600

- name: reconfigure slurm.conf for cluster
  template: src=configure_slurm.py.j2 dest=/usr/sbin/configure_slurm.py


- name: restart slurmctld and slurmd
  supervisorctl: name={{ item }} state=restarted
  with_items:
    - slurmctld
    - slurmd

- name: ensure upload_store directory in shared database/tmp
  file: path=/home/galaxy/galaxy/database/tmp/upload_store state=directory owner={{ galaxy_user_name }} group={{ galaxy_user_gid }}
  
- name: adjust nginx_upload_store in galaxy.ini
  replace:
    dest: "{{ galaxy_config_dir }}/galaxy.ini"
    regexp: '^nginx_upload_store = .+'
    replace: 'nginx_upload_store = /home/galaxy/galaxy/database/tmp/upload_store'
    backup: yes
    
- name: adjust nginx_upload_store in /etc/nginx/nginx.conf
  replace:
    dest: /etc/nginx/nginx.conf
    regexp: 'upload_store .+;'
    replace: 'upload_store /home/galaxy/galaxy/database/tmp/upload_store;'
    backup: yes
    
- name: restart nginx and galaxy
  supervisorctl: name={{ item }} state=restarted
  with_items:
    - 'galaxy:'
    - 'nginx'
